# Sistema de IrrigaÃ§Ã£o Inteligente e Monitoramento de Cultivo

## ğŸ“‹ VisÃ£o Geral

O sistema foi expandido para incluir **irrigaÃ§Ã£o automÃ¡tica inteligente** baseada em parÃ¢metros ideais de cultivo configurÃ¡veis. Agora o ESP32 nÃ£o apenas monitora os sensores, mas tambÃ©m toma decisÃµes automatizadas para garantir condiÃ§Ãµes Ã³timas para o crescimento da planta.

## ğŸŒ± ParÃ¢metros de Cultivo (PadrÃ£o: Tomate)

O sistema estÃ¡ prÃ©-configurado com valores ideais para cultivo de **tomate**:

### Temperatura
- **MÃ­nima:** 18Â°C
- **MÃ¡xima:** 28Â°C

### Umidade do Ar
- **MÃ­nima:** 60%
- **MÃ¡xima:** 80%

### Umidade do Solo
- **MÃ­nima:** 60%
- **MÃ¡xima:** 80%

### ExposiÃ§Ã£o UV
- **MÃ­nima:** 30%
- **MÃ¡xima:** 70%

### IrrigaÃ§Ã£o
- **Limiar:** 25% abaixo do ideal
- **Modo:** AutomÃ¡tico (ativado por padrÃ£o)
- **DuraÃ§Ã£o:** 10 segundos por ciclo

## ğŸš° Como Funciona a IrrigaÃ§Ã£o AutomÃ¡tica

### LÃ³gica de AtivaÃ§Ã£o

```
Umidade Atual < (Umidade MÃ­nima - Limiar)
      â†“
60% (atual) < (60% - 25%) = 35%
      â†“
   IRRIGA!
```

### Fluxo de OperaÃ§Ã£o

1. **Monitoramento contÃ­nuo:** A cada 20 segundos, o sensor de umidade do solo lÃª o valor
2. **VerificaÃ§Ã£o:** O sistema compara com o limiar configurado
3. **DecisÃ£o:** Se umidade < (ideal_min - 25%), aciona irrigaÃ§Ã£o
4. **AÃ§Ã£o:** 
   - Liga o solenoide (GPIO 26)
   - Publica alerta no MQTT (`esp32/alerts`)
   - MantÃ©m por 10 segundos
   - Desliga o solenoide
5. **NotificaÃ§Ã£o:** Registra no log e avisa via MQTT

### Exemplo de Alerta AutomÃ¡tico

```json
{
  "device_id": "ESP32_Client",
  "type": "auto_irrigation",
  "moisture": 32,
  "threshold": 35,
  "timestamp": 1234567890
}
```

## ğŸ“¡ Novos TÃ³picos MQTT

### `esp32/config` (RecepÃ§Ã£o)

**FunÃ§Ã£o:** Atualizar remotamente os parÃ¢metros de cultivo

**Formato de mensagem:**

```json
{
  "temperature_min": 20,
  "temperature_max": 28,
  "humidity_min": 65,
  "humidity_max": 75,
  "soil_moisture_min": 55,
  "soil_moisture_max": 75,
  "uv_min": 25,
  "uv_max": 65,
  "irrigation_threshold": 30,
  "auto_irrigation": true
}
```

**Exemplo de uso (AWS IoT Test):**

```bash
# TÃ³pico: esp32/config

# Mudar limiar de irrigaÃ§Ã£o para 30%
{"irrigation_threshold": 30}

# Desativar irrigaÃ§Ã£o automÃ¡tica
{"auto_irrigation": false}

# Atualizar faixa ideal de temperatura
{"temperature_min": 22, "temperature_max": 26}

# Atualizar mÃºltiplos parÃ¢metros
{
  "soil_moisture_min": 70,
  "soil_moisture_max": 85,
  "irrigation_threshold": 20
}
```

### `esp32/alerts` (PublicaÃ§Ã£o)

**FunÃ§Ã£o:** Notificar quando parÃ¢metros estÃ£o fora do ideal ou quando irrigaÃ§Ã£o Ã© acionada

**Tipos de alertas:**

1. **IrrigaÃ§Ã£o AutomÃ¡tica**
```json
{
  "device_id": "ESP32_Client",
  "type": "auto_irrigation",
  "moisture": 30,
  "threshold": 35,
  "timestamp": 1234567890
}
```

2. **Temperatura Baixa**
```json
{
  "alerts": [{
    "type": "temp_low",
    "value": 15,
    "min": 18
  }]
}
```

3. **MÃºltiplos Alertas**
```json
{
  "alerts": [
    {"type": "temp_high", "value": 32, "max": 28},
    {"type": "humidity_low", "value": 45, "min": 60},
    {"type": "soil_low", "value": 40, "min": 60}
  ]
}
```

## ğŸ§ª Como Testar o Sistema

### 1. Monitorar a ConfiguraÃ§Ã£o Atual

Ao iniciar o ESP32, o log mostrarÃ¡:

```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸŒ± ConfiguraÃ§Ã£o Ideal da Planta (Tomate) ğŸŒ±  
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸŒ¡ï¸  Temperatura: 18Â°C - 28Â°C
ğŸ’¨ Umidade Ar:  60% - 80%
ğŸ’§ Umidade Solo: 60% - 80%
â˜€ï¸  ExposiÃ§Ã£o UV: 30% - 70%
ğŸš° IrrigaÃ§Ã£o automÃ¡tica: ATIVADA (limiar: -25%)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### 2. Simular Solo Seco

**OpÃ§Ã£o A: Remover sensor do solo**
- Sensor fora do solo = leitura alta (seco)
- Umidade calculada ficarÃ¡ abaixo de 35%
- Sistema automaticamente acionarÃ¡ irrigaÃ§Ã£o

**OpÃ§Ã£o B: Ajustar limiar via MQTT**
```bash
# Publicar em: esp32/config
{"irrigation_threshold": 50}
```
- Agora irriga quando: umidade < 10% (60% - 50%)

### 3. Verificar IrrigaÃ§Ã£o no Monitor Serial

```
I (xxxxx) SOIL_MOISTURE: ğŸ“¤ Publicado [msg_id=123]: {"moisture_percent":32,...}
W (xxxxx) SOIL_MOISTURE: âš ï¸  IRRIGAÃ‡ÃƒO NECESSÃRIA!
W (xxxxx) SOIL_MOISTURE:    Umidade atual: 32%
W (xxxxx) SOIL_MOISTURE:    Limiar: 35% (ideal: 60% - 25%)
W (xxxxx) SOIL_MOISTURE: ğŸš° Acionando irrigaÃ§Ã£o automÃ¡tica!
I (xxxxx) SOLENOID: ğŸŸ¢ Solenoide LIGADO (GPIO 26 = HIGH)
... (10 segundos) ...
I (xxxxx) SOLENOID: ğŸ”´ Solenoide DESLIGADO (GPIO 26 = LOW)
I (xxxxx) SOIL_MOISTURE: âœ… IrrigaÃ§Ã£o automÃ¡tica concluÃ­da
```

### 4. Testar AtualizaÃ§Ã£o Remota de ConfiguraÃ§Ã£o

**No AWS IoT Console â†’ Test:**

```bash
# Publicar para: esp32/config

# Teste 1: Mudar para cultivo de alface
{
  "temperature_min": 15,
  "temperature_max": 22,
  "humidity_min": 70,
  "humidity_max": 85,
  "soil_moisture_min": 70,
  "soil_moisture_max": 85,
  "uv_min": 20,
  "uv_max": 50,
  "irrigation_threshold": 20
}

# Teste 2: Desativar auto-irrigaÃ§Ã£o
{"auto_irrigation": false}

# Teste 3: Apenas ajustar limiar
{"irrigation_threshold": 15}
```

### 5. Monitorar Alertas

**Subscrever em:** `esp32/alerts`

VocÃª receberÃ¡ notificaÃ§Ãµes quando:
- IrrigaÃ§Ã£o for acionada automaticamente
- Temperatura sair da faixa ideal
- Umidade do ar fora do ideal
- Umidade do solo crÃ­tica
- ExposiÃ§Ã£o UV inadequada

## ğŸ”§ ParÃ¢metros por Tipo de Planta

### Tomate (PadrÃ£o)
```json
{
  "temperature_min": 18, "temperature_max": 28,
  "humidity_min": 60, "humidity_max": 80,
  "soil_moisture_min": 60, "soil_moisture_max": 80,
  "uv_min": 30, "uv_max": 70,
  "irrigation_threshold": 25
}
```

### Alface
```json
{
  "temperature_min": 15, "temperature_max": 22,
  "humidity_min": 70, "humidity_max": 85,
  "soil_moisture_min": 70, "soil_moisture_max": 85,
  "uv_min": 20, "uv_max": 50,
  "irrigation_threshold": 20
}
```

### PimentÃ£o
```json
{
  "temperature_min": 20, "temperature_max": 30,
  "humidity_min": 60, "humidity_max": 75,
  "soil_moisture_min": 65, "soil_moisture_max": 80,
  "uv_min": 35, "uv_max": 75,
  "irrigation_threshold": 25
}
```

### ManjericÃ£o
```json
{
  "temperature_min": 18, "temperature_max": 25,
  "humidity_min": 50, "humidity_max": 70,
  "soil_moisture_min": 60, "soil_moisture_max": 75,
  "uv_min": 40, "uv_max": 80,
  "irrigation_threshold": 20
}
```

## ğŸ“Š Arquitetura do Sistema

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ESP32 - Estufa Inteligente          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚              â”‚              â”‚
        â–¼              â–¼              â–¼
   Sensores      ConfiguraÃ§Ã£o     Atuadores
        â”‚              â”‚              â”‚
  â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
  â”‚ UV Sensor â”‚  â”‚ Plant   â”‚   â”‚ Solenoide â”‚
  â”‚ DHT11     â”‚  â”‚ Config  â”‚   â”‚ (GPIO 26) â”‚
  â”‚ Umid.Solo â”‚  â”‚ Manager â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚              â”‚              
        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              
               â–¼                      
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                
         â”‚   MQTT   â”‚                
         â”‚  Broker  â”‚                
         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                
              â”‚                      
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”             
      â–¼                â–¼             
 esp32/config    esp32/alerts        
 (recebe)        (publica)           
      â”‚                â”‚             
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             
            â”‚                        
            â–¼                        
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                
    â”‚ LÃ³gica Auto  â”‚                
    â”‚   IrrigaÃ§Ã£o  â”‚                
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                
```

## ğŸ” VerificaÃ§Ã£o de Funcionamento

### Checklist de Teste

- [ ] Sistema inicia e mostra configuraÃ§Ã£o padrÃ£o
- [ ] Sensores publicam dados nos tÃ³picos corretos
- [ ] SubscriÃ§Ã£o em `esp32/config` ativa
- [ ] PublicaÃ§Ã£o de configuraÃ§Ã£o atual ao conectar
- [ ] Teste manual de irrigaÃ§Ã£o via `esp32/solenoid`
- [ ] Teste de solo seco aciona irrigaÃ§Ã£o automÃ¡tica
- [ ] Alerta publicado em `esp32/alerts` durante irrigaÃ§Ã£o
- [ ] AtualizaÃ§Ã£o remota via `esp32/config` funciona
- [ ] Log mostra nova configuraÃ§Ã£o apÃ³s atualizaÃ§Ã£o
- [ ] DesativaÃ§Ã£o de auto-irrigaÃ§Ã£o via MQTT funciona

### Comandos de Teste RÃ¡pido

```bash
# 1. Ver configuraÃ§Ã£o atual no log
idf.py monitor

# 2. No AWS IoT Test, subscrever:
esp32/alerts
esp32/config
esp32/soil_moisture

# 3. Publicar teste de irrigaÃ§Ã£o manual:
# TÃ³pico: esp32/solenoid
{"state": true}

# 4. Aguardar 5 segundos, desligar:
{"state": false}

# 5. Testar auto-irrigaÃ§Ã£o ajustando limiar:
# TÃ³pico: esp32/config
{"irrigation_threshold": 80}
# Com limiar alto, prÃ³xima leitura acionarÃ¡ irrigaÃ§Ã£o
```

## ğŸš¨ Troubleshooting

### IrrigaÃ§Ã£o nÃ£o aciona automaticamente

**PossÃ­veis causas:**
1. `auto_irrigation` estÃ¡ desativado
   - SoluÃ§Ã£o: `{"auto_irrigation": true}` em `esp32/config`

2. Umidade nÃ£o estÃ¡ abaixo do limiar
   - Verificar: Log mostra valor de umidade
   - SoluÃ§Ã£o: Ajustar limiar ou simular solo seco

3. MQTT desconectado
   - Verificar: Log mostra "MQTT nÃ£o conectado"
   - SoluÃ§Ã£o: Verificar WiFi e certificados

### ConfiguraÃ§Ã£o nÃ£o atualiza via MQTT

**PossÃ­veis causas:**
1. NÃ£o subscreveu em `esp32/config`
   - Verificar: Log deve mostrar "Subscribed: esp32/config"
   - SoluÃ§Ã£o: Reiniciar ESP32

2. JSON malformado
   - Verificar: Usar validador JSON online
   - SoluÃ§Ã£o: Corrigir sintaxe

3. Policy nÃ£o permite publicaÃ§Ã£o
   - Verificar: Erro "CONNECTION_REFUSED" no log
   - SoluÃ§Ã£o: Atualizar policy AWS IoT

### Alertas nÃ£o aparecem no MQTT

**PossÃ­veis causas:**
1. Nenhum parÃ¢metro fora do ideal
   - Normal: Alertas sÃ³ aparecem quando hÃ¡ problema

2. NÃ£o subscreveu em `esp32/alerts`
   - SoluÃ§Ã£o: Subscrever no AWS IoT Test

3. Auto-irrigaÃ§Ã£o desativada
   - Alertas de irrigaÃ§Ã£o sÃ³ aparecem se `auto_irrigation: true`

## ğŸ“ Notas de ImplementaÃ§Ã£o

### DecisÃµes de Design

1. **Parse JSON simples:** Usa `sscanf` e `strstr` ao invÃ©s de biblioteca pesada (cJSON)
2. **IrrigaÃ§Ã£o bloqueante:** Durante os 10s de irrigaÃ§Ã£o, a task fica em delay
3. **Valores padrÃ£o:** Tomate foi escolhido como planta padrÃ£o
4. **Limiar percentual:** Facilita ajuste sem recalcular valores absolutos

### LimitaÃ§Ãµes Conhecidas

1. **Parse JSON simplificado:** NÃ£o valida estrutura completa
2. **Sem persistÃªncia:** ConfiguraÃ§Ã£o volta ao padrÃ£o apÃ³s reiniciar
3. **IrrigaÃ§Ã£o Ãºnica:** NÃ£o hÃ¡ controle de vazÃ£o ou volume total
4. **Sem histÃ³rico:** NÃ£o armazena dados de irrigaÃ§Ãµes anteriores

### Melhorias Futuras

- [ ] Salvar configuraÃ§Ã£o na NVS (persistir apÃ³s reboot)
- [ ] Controle de volume de Ã¡gua irrigado
- [ ] Agendamento de irrigaÃ§Ã£o (horÃ¡rios especÃ­ficos)
- [ ] Logs de eventos (histÃ³rico de irrigaÃ§Ãµes)
- [ ] Dashboard web para visualizaÃ§Ã£o
- [ ] NotificaÃ§Ãµes push quando parÃ¢metros crÃ­ticos
- [ ] Machine Learning para otimizar parÃ¢metros
- [ ] Controle de mÃºltiplos setores/plantas

## ğŸ“š ReferÃªncias

- [Guia de Cultivo de Tomate](https://www.embrapa.br)
- [ESP-IDF MQTT Documentation](https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/protocols/mqtt.html)
- [AWS IoT Core Documentation](https://docs.aws.amazon.com/iot/latest/developerguide/)
- [IrrigaÃ§Ã£o Inteligente - Conceitos](https://www.fao.org/land-water/water/en/)

---

**VersÃ£o do Sistema:** 2.0  
**Data de AtualizaÃ§Ã£o:** 2025  
**Arquitetura:** Modular com irrigaÃ§Ã£o automÃ¡tica inteligente
