# Guia Completo de T√≥picos MQTT

## üì° Vis√£o Geral

Este documento descreve todos os t√≥picos MQTT utilizados pelo sistema de estufa inteligente, incluindo formato de mensagens, exemplos pr√°ticos e casos de uso.

## üì§ T√≥picos de Publica√ß√£o (ESP32 ‚Üí AWS IoT)

### `esp32/uv`

**Frequ√™ncia:** A cada 15 segundos  
**Fun√ß√£o:** Publicar leituras do sensor UV

**Formato:**
```json
{
  "device_id": "ESP32_Client",
  "uv_raw": 2048,
  "uv_voltage": 1.65,
  "counter": 42,
  "timestamp": 1234567890
}
```

**Campos:**
- `device_id`: Identificador do dispositivo
- `uv_raw`: Valor bruto do ADC (0-4095)
- `uv_voltage`: Tens√£o calculada em volts (0-3.3V)
- `counter`: Contador de mensagens enviadas
- `timestamp`: Timestamp em milissegundos

**Exemplo de uso:**
```bash
# Subscrever no AWS IoT Test
T√≥pico: esp32/uv
```

---

### `esp32/soil_moisture`

**Frequ√™ncia:** A cada 20 segundos  
**Fun√ß√£o:** Publicar leituras de umidade do solo + controle de irriga√ß√£o autom√°tica

**Formato:**
```json
{
  "device_id": "ESP32_Client",
  "moisture_raw": 1024,
  "moisture_percent": 75,
  "counter": 30,
  "timestamp": 1234567890
}
```

**Campos:**
- `device_id`: Identificador do dispositivo
- `moisture_raw`: Valor bruto do ADC (0-4095)
- `moisture_percent`: Porcentagem de umidade (0-100%)
  - 0% = completamente seco (ADC = 4095)
  - 100% = completamente molhado (ADC = 0)
- `counter`: Contador de mensagens
- `timestamp`: Timestamp em milissegundos

**Comportamento especial:**
Se `moisture_percent < (ideal_min - threshold)`, o sistema:
1. Liga o solenoide automaticamente
2. Publica alerta em `esp32/alerts`
3. Mant√©m por 10 segundos
4. Desliga o solenoide

---

### `esp32/dht11`

**Frequ√™ncia:** A cada 10 segundos  
**Fun√ß√£o:** Publicar temperatura e umidade do ar

**Formato:**
```json
{
  "device_id": "ESP32_Client",
  "temperature": 25,
  "humidity": 65,
  "counter": 60,
  "timestamp": 1234567890
}
```

**Campos:**
- `device_id`: Identificador do dispositivo
- `temperature`: Temperatura em graus Celsius (inteiro)
- `humidity`: Umidade relativa do ar em porcentagem (inteiro)
- `counter`: Contador de mensagens
- `timestamp`: Timestamp em milissegundos

**Observa√ß√£o:** DHT11 tem precis√£o de ¬±2¬∞C e ¬±5% de umidade

---

### `esp32/alerts`

**Frequ√™ncia:** Sob demanda (quando h√° alertas)  
**Fun√ß√£o:** Notificar eventos importantes e par√¢metros fora do ideal

**Formato 1 - Irriga√ß√£o Autom√°tica:**
```json
{
  "device_id": "ESP32_Client",
  "type": "auto_irrigation",
  "moisture": 32,
  "threshold": 35,
  "timestamp": 1234567890
}
```

**Formato 2 - M√∫ltiplos Alertas de Par√¢metros:**
```json
{
  "alerts": [
    {
      "type": "temp_low",
      "value": 15,
      "min": 18
    },
    {
      "type": "soil_low",
      "value": 45,
      "min": 60
    }
  ]
}
```

**Tipos de alertas:**
- `auto_irrigation`: Irriga√ß√£o autom√°tica acionada
- `temp_low`: Temperatura abaixo do ideal
- `temp_high`: Temperatura acima do ideal
- `humidity_low`: Umidade do ar abaixo do ideal
- `humidity_high`: Umidade do ar acima do ideal
- `soil_low`: Umidade do solo abaixo do ideal
- `soil_high`: Umidade do solo acima do ideal
- `uv_low`: Exposi√ß√£o UV abaixo do ideal
- `uv_high`: Exposi√ß√£o UV acima do ideal

---

### `esp32/config` (Publica√ß√£o inicial)

**Frequ√™ncia:** Uma vez ao conectar  
**Fun√ß√£o:** Publicar configura√ß√£o atual da planta

**Formato:**
```json
{
  "device_id": "ESP32_Client",
  "temperature_min": 18,
  "temperature_max": 28,
  "humidity_min": 60,
  "humidity_max": 80,
  "soil_moisture_min": 60,
  "soil_moisture_max": 80,
  "uv_min": 30,
  "uv_max": 70,
  "irrigation_threshold": 25,
  "auto_irrigation": true
}
```

---

## üì• T√≥picos de Subscri√ß√£o (AWS IoT ‚Üí ESP32)

### `esp32/solenoid`

**Fun√ß√£o:** Controlar manualmente o solenoide de irriga√ß√£o

**Formato 1 - Boolean:**
```json
{
  "state": true
}
```

**Formato 2 - String:**
```json
{
  "state": "on"
}
```

**Valores aceitos:**
- `true`, `"true"`, `"on"`, `"ON"`, `1` ‚Üí Liga solenoide
- `false`, `"false"`, `"off"`, `"OFF"`, `0` ‚Üí Desliga solenoide

**Exemplo de teste manual:**
```bash
# No AWS IoT Test, publicar em esp32/solenoid

# Ligar
{"state": true}

# Aguardar alguns segundos...

# Desligar
{"state": false}
```

**Hardware:**
- GPIO: 26
- Estado HIGH (1) = Solenoide LIGADO
- Estado LOW (0) = Solenoide DESLIGADO

---

### `esp32/config`

**Fun√ß√£o:** Atualizar remotamente os par√¢metros de cultivo da planta

**Formato completo:**
```json
{
  "temperature_min": 18,
  "temperature_max": 28,
  "humidity_min": 60,
  "humidity_max": 80,
  "soil_moisture_min": 60,
  "soil_moisture_max": 80,
  "uv_min": 30,
  "uv_max": 70,
  "irrigation_threshold": 25,
  "auto_irrigation": true
}
```

**Formato parcial (atualiza apenas campos especificados):**
```json
{
  "irrigation_threshold": 30
}
```

**Par√¢metros:**
- `temperature_min/max`: Faixa ideal de temperatura (¬∞C)
- `humidity_min/max`: Faixa ideal de umidade do ar (%)
- `soil_moisture_min/max`: Faixa ideal de umidade do solo (%)
- `uv_min/max`: Faixa ideal de exposi√ß√£o UV (%)
- `irrigation_threshold`: Porcentagem abaixo do ideal para acionar irriga√ß√£o
- `auto_irrigation`: Ativar/desativar irriga√ß√£o autom√°tica (boolean)

**Exemplos pr√°ticos:**

1. **Mudar para cultivo de alface:**
```json
{
  "temperature_min": 15,
  "temperature_max": 22,
  "humidity_min": 70,
  "humidity_max": 85,
  "soil_moisture_min": 70,
  "soil_moisture_max": 85,
  "uv_min": 20,
  "uv_max": 50,
  "irrigation_threshold": 20
}
```

2. **Desativar irriga√ß√£o autom√°tica:**
```json
{
  "auto_irrigation": false
}
```

3. **Tornar irriga√ß√£o mais sens√≠vel (aciona com menos falta de √°gua):**
```json
{
  "irrigation_threshold": 15
}
```

4. **Tornar irriga√ß√£o menos sens√≠vel:**
```json
{
  "irrigation_threshold": 35
}
```

5. **Apenas ajustar umidade do solo ideal:**
```json
{
  "soil_moisture_min": 70,
  "soil_moisture_max": 85
}
```

---

## üß™ Guia de Testes no AWS IoT Core

### 1. Monitorar Todos os Sensores

```bash
# Subscrever em:
esp32/#
```

Isso captura **todos** os t√≥picos que come√ßam com `esp32/`

### 2. Monitorar Apenas Sensores

```bash
# Subscrever em m√∫ltiplos t√≥picos:
esp32/uv
esp32/soil_moisture
esp32/dht11
```

### 3. Monitorar Apenas Alertas

```bash
# Subscrever em:
esp32/alerts
```

### 4. Teste Completo de Irriga√ß√£o Manual

**Passo 1 - Subscrever em alertas:**
```bash
T√≥pico: esp32/alerts
```

**Passo 2 - Ligar solenoide:**
```bash
Publicar em: esp32/solenoid
Mensagem: {"state": true}
```

**Passo 3 - Observar no monitor serial:**
```
I (xxxxx) SOLENOID: üü¢ Solenoide LIGADO (GPIO 26 = HIGH)
```

**Passo 4 - Aguardar 5-10 segundos**

**Passo 5 - Desligar solenoide:**
```bash
Publicar em: esp32/solenoid
Mensagem: {"state": false}
```

**Passo 6 - Observar no monitor serial:**
```
I (xxxxx) SOLENOID: üî¥ Solenoide DESLIGADO (GPIO 26 = LOW)
```

### 5. Teste de Irriga√ß√£o Autom√°tica

**Passo 1 - Subscrever em t√≥picos relevantes:**
```bash
esp32/soil_moisture
esp32/alerts
```

**Passo 2 - Ajustar limiar para facilitar acionamento:**
```bash
Publicar em: esp32/config
Mensagem: {"irrigation_threshold": 80}
```

Agora irriga quando: `moisture < (60% - 80%) = -20%` (sempre irriga!)

**Passo 3 - Aguardar pr√≥xima leitura de solo (20s)**

**Passo 4 - Observar alerta autom√°tico:**
```json
{
  "device_id": "ESP32_Client",
  "type": "auto_irrigation",
  "moisture": 45,
  "threshold": -20,
  "timestamp": 1234567890
}
```

**Passo 5 - Restaurar limiar normal:**
```bash
Publicar em: esp32/config
Mensagem: {"irrigation_threshold": 25}
```

### 6. Teste de Mudan√ßa de Planta

**Passo 1 - Ver configura√ß√£o atual:**
```bash
# Subscrever em:
esp32/config

# Configura√ß√£o ser√° publicada automaticamente ao conectar
```

**Passo 2 - Mudar para alface:**
```bash
# Usar o script Python:
python3 test_irrigation.py --config alface

# Copiar JSON gerado e publicar em:
esp32/config
```

**Passo 3 - Verificar no monitor serial:**
```
I (xxxxx) PLANT_CONFIG: üì• Atualizando configura√ß√£o da planta...
I (xxxxx) PLANT_CONFIG: ‚úÖ Configura√ß√£o atualizada com sucesso!
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   üå± Configura√ß√£o Ideal da Planta (Alface) üå±  
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üå°Ô∏è  Temperatura: 15¬∞C - 22¬∞C
üí® Umidade Ar:  70% - 85%
...
```

---

## üîç Filtros MQTT e Wildcards

### Wildcards Suportados

**`#` (multi-level wildcard):**
- Subscreve em todos os sub-t√≥picos
- Exemplo: `esp32/#` ‚Üí pega esp32/uv, esp32/config, esp32/alerts/critical, etc.

**`+` (single-level wildcard):**
- Subscreve em um n√≠vel espec√≠fico
- Exemplo: `esp32/+/sensor` ‚Üí pega esp32/bedroom/sensor, esp32/kitchen/sensor

### Exemplos Pr√°ticos

```bash
# Todos os t√≥picos do ESP32
esp32/#

# Apenas sensores (n√£o pega config/alerts)
esp32/+

# Qualquer alerta
esp32/alerts/#

# Todos os dispositivos publicando em "temperature"
+/temperature
```

---

## üìä Taxa de Mensagens

| T√≥pico | Frequ√™ncia | Bytes/msg | Bytes/min |
|--------|------------|-----------|-----------|
| esp32/uv | 15s | ~120 | ~480 |
| esp32/soil_moisture | 20s | ~130 | ~390 |
| esp32/dht11 | 10s | ~110 | ~660 |
| esp32/alerts | Sob demanda | ~150 | Vari√°vel |
| **TOTAL** | - | - | **~1530** |

**Taxa m√©dia:** ~1.5 KB/min (~90 KB/hora)  
**Custo AWS IoT (us-east-1):** ~$5 por milh√£o de mensagens

---

## üîê Policy AWS IoT Recomendada

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": "iot:Connect",
      "Resource": "arn:aws:iot:us-east-1:*:client/ESP32_Client"
    },
    {
      "Effect": "Allow",
      "Action": "iot:Publish",
      "Resource": [
        "arn:aws:iot:us-east-1:*:topic/esp32/uv",
        "arn:aws:iot:us-east-1:*:topic/esp32/soil_moisture",
        "arn:aws:iot:us-east-1:*:topic/esp32/dht11",
        "arn:aws:iot:us-east-1:*:topic/esp32/alerts",
        "arn:aws:iot:us-east-1:*:topic/esp32/config"
      ]
    },
    {
      "Effect": "Allow",
      "Action": "iot:Subscribe",
      "Resource": [
        "arn:aws:iot:us-east-1:*:topicfilter/esp32/solenoid",
        "arn:aws:iot:us-east-1:*:topicfilter/esp32/config"
      ]
    },
    {
      "Effect": "Allow",
      "Action": "iot:Receive",
      "Resource": [
        "arn:aws:iot:us-east-1:*:topic/esp32/solenoid",
        "arn:aws:iot:us-east-1:*:topic/esp32/config"
      ]
    }
  ]
}
```

---

## üö® Troubleshooting

### Mensagens n√£o chegam no AWS IoT

**Causa:** T√≥pico n√£o autorizado na policy  
**Solu√ß√£o:** Verificar policy anexada ao certificado

**Causa:** MQTT desconectado  
**Solu√ß√£o:** Verificar WiFi e credenciais

### ESP32 n√£o recebe comandos

**Causa:** N√£o fez subscribe no t√≥pico  
**Solu√ß√£o:** Verificar log no monitor serial

**Causa:** JSON malformado  
**Solu√ß√£o:** Validar JSON em jsonlint.com

### Alertas n√£o aparecem

**Causa:** Par√¢metros dentro do ideal (normal!)  
**Solu√ß√£o:** For√ßar condi√ß√£o cr√≠tica para teste

---

## üìö Recursos Adicionais

- [AWS IoT MQTT Protocol](https://docs.aws.amazon.com/iot/latest/developerguide/mqtt.html)
- [MQTT.org - Specification](https://mqtt.org/)
- [ESP-IDF MQTT Client](https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/protocols/mqtt.html)
- [Script de teste Python](./test_irrigation.py)
- [Documenta√ß√£o de Irriga√ß√£o](./IRRIGACAO_INTELIGENTE.md)

---

**√öltima atualiza√ß√£o:** 2025  
**Vers√£o do protocolo:** 1.0  
**QoS padr√£o:** 1 (At least once)
